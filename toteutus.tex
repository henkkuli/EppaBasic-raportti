% Täällä kerrotaan sivuston sekä kääntäjän teknisestä toteutuksesta.

\section{Tekninen toteutus}
Tässä luvussa kerron mahdollisimman tarkasti,
miten EppaBasic on toteutettu.
Luvun lukeminen vaatii esitietoja
ohjelmoinnista ja kääntäjien toiminnasta.

Jotta EppaBasic toimisi mahdollisimman monella
tietokonejärjestelmällä laitteistosta ja
käyttöjärjestelmästä riippumatta,
päätimme toteuttaa kaiken ohjelmointi-
ja suoritusympäristöä myöten
selainpohjaisesti.
Näin EppaBasicin käyttäminen toimii niin
Windows-, Linux- ja OS X -koneilla
kuin myös monilla mobiililaitteilla.
Lisäksi modernit selaimet tarjoavat
monia hyödyllisiä ominaisuuksia
kuten yksinkertaisen tavan toteuttaa
käyttöliittymiä (HTML \cite{w3c_html})
sekä tehokkaan tavan piirtää grafiikkaa
näytölle (HTML Canvas \cite{mdn_canvas}).
Koko ohjelmakoodi EppaBasicin takana
on kirjoitettu JavaScriptillä,
joka on ainoa yleisesti selaimissa
tuettu ohjelmointikieli \cite{mdn_about_js}.

JavaScript-koodi EppaBasicin takana
on jaettu moduuleihin koodin
rakenteen selkeyttämiseksi.
Moduulien lataamiseen käytettään
RequireJS-kirjastoa \cite{requirejs}.
Moduulien käyttämällä voi kirjoittaa
selkeämpää kuin ilman moduuleja,
koska moduulien riippuvuudet ovat
näkyvissä moduulin määrittelyssä.
RequireJS mahdollistaa myös kooditiedostojen
yhdistämisen ja pienentämisen ennen selaimelle
lähettämistä käyttäen r.js-ohjelmaa \cite{r.js}.

EppaBasicin kääntäjä kääntää ohjelmat
asm.js-koodiksi \cite{asm.js}.
Asm.js-koodi on tavallista
JavaScript-koodia, jonka
ominaisuuksia on rajoitettu siten,
että jotkin selaimet osaavat
suorittaa koodia tavallista
nopeammin.
Ainakin uusien Mozilla Firefoxin
ja Google Chromen versioiden
tiedetään suorittavan
asm.js-koodia nopeammin
kuin vastaavaa tavallista
JavaScript-koodia.
Asm.js-koodin käyttäminen
ei kuitenkaan rajoita
EppaBasicin ominaisuuksia,
sillä asm.js-koodista
voidaan kutsua myös
tavallisia JavaScript-funktioita,
joissa voidaan toteuttaa
puuttuvat toiminnallisuudet.


\subsection{Kääntäjä}
EppaBasicin kääntäjä koostuu kahdesta osasta:
ensivaiheesta (eng. front-end) ja
loppuvaiheesta (eng. back-end).
Molemmat vaiheet on jaettu omiin moduuleihinsa,
minkä lisäksi kääntäjässä on yksi apumoduuli,
joka mahdollistaa eri kääntäjän vaiheiden
suorittamisen helposti.

Eräs tapa jakaa kääntäjä osiin on jakaa
se kolmeen osaan:
ensivaiheeseen (eng. front-end),
välivaiheeseen (eng. middleware) ja
loppuvaiheeseen (eng. back-end).
EppaBasicissa ei ole erillistä välivaihetta,
sillä kääntäjä ei vielä tarvitse sellaista.
Tulevaisuudessa on tarkoitus toteuttaa
välivaiheeseen muun muassa optimoija,
joka nopeuttaa koodin suoritusta.

\subsubsection{Ensivaihe}
Ensivaihe on kääntämisen ensimmäinen vaihe.
Sen tehtävä on tulkita käyttäjän kirjoittama
EppaBasic-koodi ja muuttaa se kääntäjän
sisäiseen muotoon.
EppaBasicissa ensivaihe on myös ainoa
vaihe, joka voi kertoa käyttäjälle
koodissa olevista virheistä.

EppaBasicin kääntäjä käyttää sisäisenä
esitysmuotonaan abstraktia syntaksipuuta
(eng. abstract syntax tree, AST).
Siinä puun juuri vastaa koko ohjelmaa,
ja jokainen solmu vastaa tiettyä
syntaksillista osaa.
Esimerkiksi komentorakenteilla,
laskuoperaattoreilla ja
funktiomäärityksillä
on omat solmunsa, joilla on eri määrä lapsia.
Puun lehtiä ovat esimerkiksi
muuttujaviittaukset ja vakiot.
\fxnote{Tarkista määritelmä eac2e:stä}

EppaBasicin ensivaihe muodostuu
kolmesa osasta:
lukijasta (eng. lexer),
jäsentäjästä (eng. parser) ja
tyyppientarkastajasta.

Lukija lukee lähdekoodin alusta loppuun
ja jakaa sen merkityksellisiin osiin,
merkkeihin (eng. token),
Merkkejä ovat erilaiset kielen
avainsanat (\eb{If}, \eb{Then}, \eb{EndIf}, jne.),
luvut (\eb{15}, \eb{-30}, jne.),
merkkijonot (\eb{"HelloWorld"}, \eb{"Tekstiä"}, jne.),
muuttujien ja funktioiden nimet (\eb{Print}, \eb{x}, jne.),
kommentit (\eb{' Kommentit alkavat heittomerkillä}, jne.),
erikoismerkit (\eb{+}, \eb{-}, \eb{^}, jne.) sekä
rivinvaihdot ja välilyöntimerkit.
Jos lukija löytää pätkän koodia,
jota se ei voi jakaa kuuluvaksi
edellä mainittuihin ryhmiin,
lukija kertoo käyttäjälle virheestä.

Jäsentäjä tulkitsee lukijalta saamansa
merkkivirran ja muodostaa sen pohjalta
ohjelmakoodin AST-puun.
EppaBasicin jäsentäjä on tyypiltään
\emph{käsinkirjoitettu, rekursiivin,
ylhäältä-alas-jäsentäjä}
(eng. \emph{hand-coded, recursive-descent,
top-down parser} \cite[kappale 3.3.2]{eac2e}).
EppaBasic käyttää tällaista jäsentäjää,
koska se on yksinkertainen toteuttaa,
helposti ymmärrettävä ja tehokas.
Näin ominaisuuksien lisääminen
kääntäjään on helppoa.

Rekursiivinen ylhäältä-alas-jäsentäjä
toimii siten, että funktion aluksi
se lukee seuraavan merkin virrasta,
minkä perusteella se kutsuu seuraavaa
funktiota.
Funktiot palauttavat muodostamansa
AST-alipuun.

Jäsentämisen jälkeen tyyppientarkastaja
käy rekursiivisesti läpi jäsentäjän
luoman AST-puun.
Se pitää kirjaa jokaisessa kohdassa
näkyvistä muuttujista ja niiden tyypeistä.
Näin tyyppientarkastaja voi päätellä
jokaiselle lausekkeelle tyypin
ja jopa kutsuttavien funktioiden
paluuarvojen tyypit.
Samalla tyyppientarkastaja selvittää,
mihin määritykseen jokainen muuttujan
käyttö viittaa ja mihin funktiomääritykseen
jokainen funktiokutus viittaa.

\subsubsection{Loppuvaihe}
Loppuvaihe on kääntämisen viimeinen vaihe,
joa muodostaa sisäisestä esitysmuodosta
ajettavan ohjelman.
EppaBasicin loppuvaihe muuttaa ohjelman
asm.js-yhteensopivaksi \cite{asm.js}
JavaScript-koodiksi.

EppaBasicin loopuvaihe käy rekursiivisesti
läpi AST-puun.
Jokainen AST-puun solmu muutetaan
vastaavaksi pätkäksi asm.js-koodia.

EppaBasicin loppuvaihetta monimutkaistaa se,
että EppaBasic mahdollistaa ruudun piirtämisen
keskellä komentorakenteita.
JavaScriptissä (ja siten myös asm.js:ssä)
ruudun päivittäminen ja käyttäjän syötteiden
lukeminen vaatii sen, että JavaScript-koodin
suorittaminen loppuu edes hetkeksi.
JavaScriptissä ei kuitenkaan ole
mahdollista tallentaa suorituksen tilaa
komentorakenteessa ja palata siihen.
Tämän takia kääntäjän loppuvaihe
joutuu muokkaamaan käännettävää
koodia siten, että suoritusta
voidaan näennäisesti jatkaa
keskeltä komentorakennetta.

Loppuvaihe merkitsee jokaiselle
AST-puun solmulle atomisuuden
eli jakamattomuuden.
Jakamattomuus merkitsee sitä,
että suoritusta ei tarvitse eikä voi
katkaista kyseisen solmun sisällä.
Kaikki solmut ovat aluksi atomisia.
Sen jälkeen merkitään jokainen
funktion \eb{DrawScreen} (päivittää ruudun)
kutsu epäatomiseksi.
Tämän jälkeen merkitään solmuja
epäatomisiksi, jos jokin niiden
lapsista on epäatominen tai
kutsuttava funktio on epäatominen.
Näin epäatomisuus peritytyy
puussa ylöspäin.

Nyt loppuvaihe voi jakaa koodin
mahdollisimman pitkiin atomisiin osiin.
Vaihe luo jokaiselle atomiselle osalle oman
funktionsa ja antaa funktioille indeksin.
Ohjelman suorituksen aluksi kutsupinossa
on yksi alkio: ohjelman ensimmäinen
atominen osa.
Funktio päivittää suorituksensa
lopuksi kutsupinoa siten,
että seuraavaksi kutsuttava
funktio on päälimmäisenä.
Nyt ajoympäristö voi kutsua
pinon päällä olevaa funktiota,
pitää tauon, jonka aikana
luetaan syötteet ja tarvittaessa
päivitetään piirtopinta,
ja kutsua taas hetken kuluttua
pinon päälimmäistä funktiota.
Kun funktiopinossa ei ole
enää alkioita, ohjelman suoritus
on päättynyt.

Atomiset osat pitävät vain
itsensä sisällä tarvittavat
arvot paikallisissa muuttujissa.
Muissa osissa mahdollisesti tarvittavat
arvot tallennetaan muuttujille
varattuun pinomuistiin
(huom. eri kuin kutsupino).


\subsection{Käyttöliittymä}
EppaBasicin käyttöliittymä on toteutettu
kokonaan käytten HTML5:n tarjoamia elementtejä.
Käyttöliittymän elementtien tyylit ja asettelu
on määritelty käyttämällä CSS3:a ja
toiminallisuus on toteutettu
JavaScriptillä.

EppaBasicin käyttöliittymää ohjaava JavaScript-koodi
on jaettu moduuleihin, joista jokainen vastaa
tiettyä käyttöliitymän osaa.
Omat moduulinsa on esimerkiksi kirjautumisruudulla,
tiedostodialogeilla, käyttöoppaalla ja ilmoituksilla.
Ohjausmoduulit ovat yhteydessä HTML-näkymään
jQuery-kirjaston \cite{jquery} avulla,
mikä yksinkertaistaa ohjainten rakennetta huomattavasti.

Käyttöliittymän palvelimeen yhteydessä olevat
moduulit käyttävät Ajax-pyyntöjä
(Asyn\-chro\-nous JavaScript + XML).
Tällaisia moduuleja ovat esimerkiksi
kirjautumisen hallinta ja tiedostojen tallentaminen.
Palvelimella pyörivä Python-rajapinta varmistaa,
että pyytäjällä on oikeus pyytämiinsä tietoihin,
ja palauttaa vastauksen JSON-muodossa.

Käyttöliittymän tarjoama ohjekirja on kirjoitettu
käyttämen Markdown-merkkausta \cite{markdown}.
Käyttäjän navigoidessa ohjekirjasivulle
JavaScript-koodi hakee Ajax:in avulla palvelimelta
oikean ohjekirjasivun Markdown-muodossa,
joka muutetaan selaimen päässä HTML-muotoon käyttäen
marked-kirjasto \cite{marked}
Näin ohjekirja voidaan tarvittaessa myöhemmin
myös tulostaa ja palvelin rasituu vähemmän
kuin jos muunnos tehtäisiin palvelimella.

Ohjelmakoodin muokkaamiseen EppaBasicissa käytetään
Ace-teks\-tin\-muok\-kaus\-kom\-po\-nent\-tia \cite{ace_about}.
Komponentti mahdollistaa omien syntaksiväritysten luomisen.
Syntaksiväritys selkeyttää koodin lukemista,
sillä avainsanojen erottaminen helpottuu.
Ace mahdollistaa myös koodin kääntämisen taustalla,
mitä EppaBasicissa käytetään kertomaan käyttäjälle
tämän tekemistä virheistä jo koodin kirjoittamisen aikana.
Teknisesti tämä on toteutettu suorittamalla
kääntäjän ensivaihe mahdollisuuksien mukaan
taustasäikeessä Web Workerin \cite{w3c_web_worker} avulla.
Ensivaihe kertoo käyttöliittymälle löytämistään virheistä,
jotka käyttöliittymä näyttää käyttäjälle käyttämällä
Acen huomautuksia (eng. annotations).

\subsection{Palvelin}
EppaBasic-palvelin vastaa käyttöliitymän Ajax-pyyntöihin
vastaamisesta. Käytännössä palvelimelle tallennetaan
siis esimerkiksi rekisteröityjen käyttäjien koodit.

Palvelin on toteutettu Django-sovelluskehystä (eng. framework)
hyödyntäen. Django perustuus MVC-malliin (Model View Controller),
mikä auttaa tietoturvallisten sivustojen kehityksessä. Koodien
pysyvänä tallennuspaikkana toimii SQL-tietokanta (Structured Query Language).
Kaikki pyynnöt menevät Apache-palvelimen läpi, joka jakaa staattiset
tiedostot ja välittää tarvittavat pyynnöt
Django-sovelluspalvelimelle (eng. application server).

\subsection{Ajoympäristö}
EppaBasicin ajoympäristö on erillinen verkkosivu,
joka tarjoaa kaikille EppaBasicilla kirjoitetuille
ohjeilmille yhteiset toiminnot, kuten piirto-,
merkkijon- ja matematiikkafunktiot sekä
koodin suorittamisen ajastamiseen tarvittavat toiminnot.
Myös ajoympäristön voi laskea kuuluvaksi käyttöliittymään,
mutta esittelen sen erillään muusta käyttöliittymästä,
sillä se tarjoaa käyttöliittymänä vain piirtopinnan
ja syötteiden lukemisen, mutta ohjelmallisena
komponenttina rajapinnan ja suoritusalusta kääntäjän
kääntämien ohjelmien suorittamiselle.

Ajoympäristö aukeaa automaattisesti uuteen selainikkunaan
käyttäjän suorittaessa ohjelman ja koodin käännyttyä.
Ajoympäristö pyytää muokkausikkunalta käännetyn kooodin,
minkä jälkeen ajoympäristö alustaa itsensä ja suorittaa koodin.

Ajoympärstö koostuu kahdesta osasta:
piirtäjästä ja työskentelijästä.
Piirtäjä on tavallinen selaimessa pyörivä
JavaScript-ohjelma, joka huolehtii
näytön piirtämisestä ja käyttäjän syötteiden lukemisesta.
Työskentelijä suoritetaan omassa säikeessään
käyttäen Web Workeria.
Näin saadaan ohjelman suoritus eristettyä
irralleen käyttöliittymätoiminnoista.
Jos näin ei tehtäisi, ohjelman suorituksen
kestäessä selain ei vastaisi käyttäjän
syötteisiin ennen suorituksen taukoamista.

Piirtäjä ja työskentelijä keskustelevat
keskenään käyttäen viestejä.
Viestit voivat olla yksinkertaisia
JavaScript-merkkijonoja,
-objekteja, -taulukoita ja -lukkuja
sekä näiden yhdistelmiä.
Viestit kopioituvat lähetettäessä,
joten arvojen muuttaminen piirtäjässä
ei vaikuta työskentelijän vastaanottamaan
arvoon eikä myöskään toisinpäin.
Viestejä voi lähettää mistä tahansa kohtaa
suoritettavaa JavaScript-koodia,
mutta niiden lukemiseksi suoritus on katkaistava.
Tämä ominaisuus on suurin syy kääntäjän
tavallista monimutkaisempaan rakenteeseen.

\subsubsection{Piirtäjä}
Piirtäjä on ajoympäristön komponentti,
joka nimensä mukaisesti huolehtii
grafiikan piirtämisestä,
mutta myös käyttäjän syötteiden kirjaamisesta.
Grafiikan piirtämiseen käytetään
HTML5 Canvas -elementtiä,
joka on nykyään tuettu kaikissa moderneissa
selaimissa \cite{caniuse_canvas}.
Canvas mahdollistaa yksinkertaisten
geometristen muotojen piirtämisen tehokkaasti,
mutta myös kuvien käyttäminen on mahdollista.
Ohjeet grafiikan piirtämiseen piirtäjä
saa viesteinä työskentelijältä.
Yksi viesti sisältää useita piirtokomentoja,
jotka kaikki suoritetaan taustapuskuriin ennen
canvas-elementin päivittämistä.
Tätä kutsutaan kaksoispuskuroinniksi
(eng. double-buffering).

Syötteen (näppäimistö ja hiiri) lukemiseksi
piirtäjä kuuntelee kaikkia ajoympäristön
näp\-päin- ja hiiritapahtumia (eng. Events).
Tapahtuman lauetessa piirtäjä
lähettää tiedon muutoksesta työskentelijälle,
joka päivittää omaa tilaansa.

\subsubsection{Työskenteljiä}
Työskentelijä on ajoympäristön osa,
joka suorittaa käännetyn koodin.
Työskentelijä ajetaan taustasäikeessä
Web Wrokerin avulla, jolloin ohjelman
suoritus ei häiritse selaimen muuta toimintaa.
Työskentelijä tarjoaa EppaBasic-ohjelmille
rajapinnan, jonka avulla ne voivat käyttää
standardikirjaston funktioita.
Suurin osa näistä funktioista on toteutettu
käärimällä JavaScriptin tarjoamat valmiit
funktioit EppaBasicin ymmärtämään muotoon.
Ne funktiot, joita JavaScript ei suoraan tarjoa,
on toteutettu joko käyttämällä kolmannen osapuolen
tarjoamaa toteutusta tai yksinkertaisissa
tapauksissa toteuttamalla itse.

Työskentelijä pitää sisäistä tilaa,
joka sisältää esimerkiksi nykyisen piirtovärin
sekä näppäimistön pohjassa olevat painikkeet.
Sisäinen tila voi muuttua kahdella tavalla:
joko EppaBasic-koodissa kutsutaan komentoa,
joka muuttaa sisäistä tilaa
(esimerkiksi piirtovärin asettaminen),
tai piirtäjä lähettää viestin,
joka muuttaa sisäistä tilaa
(esimerkiksi hiiren sijainti).
Sisäinen tila vaikuttaa joidenkin
EppaBasicin komentojen palauttamiin arvoihin
(esimerkiksi \eb{KeyDown} ja \eb{MouseX})
sekä piirtokomentojen yhteydessä määrittämään
piirtokomennon tarkkaa toimintaa
(esimerkiksi viivan paksuus tai väri).


\begin{comment}
Jotta EppaBasic toimisi mahdollisimman monella tietokoneella käyttöjärjestelmästä riippumatta,
päätimme toteuttaa kaiken ohjelmointi- ja suoritusympäristöä myöten selainpohjaisesti.
Näin ohjelmointikielemme käyttäminen onnistuu niin Windows-, Linux- ja OS X -koneilla
kuin myös monilla mobiililaitteilla.
Lisäksi modernit selaimet tarjoavat monia hyödyllisiä ominaisuuksia
kuten yksinkertaisen tavan toteuttaa käyttöliittymiä (HTML \cite{w3c_html})
sekä helpon tavan piirtää grafiikkaa näytölle (\eng{HTML Canvas} \cite{mdn_canvas}).
Koko ohjelmakoodi EppaBasicin takana on kirjoitettu JavaScriptillä,
joka on ainoa yleisesti selaimissa tuettu ohjelmointikieli \cite{mdn_about_js}.

\subsection{Käyttöliittymä}
\begin{anfxnote}{}
Tässä kerrotaan käyttöliittymän rakenteesta.
Pääasiassa kerrotaan, että on toteutettu html:llä sekä javascriptillä.
Lisäksi kerrotaan kirjautumismahdollisuudesta sekä
sen tuomista eduista (tallentaminen, jakaminen).
\end{anfxnote}

EppaBasicin käyttöliittymä on toteutettu kokonaan käyttäen HTMLää sekä JavaScriptiä.
Näin on saatu aikaa kaikissa moderneissa selaimissa toimiva yhtenäinen käyttöliittymä.

EppaBasicin käyttöliittymä sisältää kaikki ohjelmoinnin kannalta tarvittavat toiminnallisuudet:
Yläpalkista löytyy ohjelman suorittamiseen tarvittava "Käynnistä"-näppäin,
tiedostojen hallintaan tarvittavat ''Uusi''-, ''Lataa''- ja ''Tallenna''-näppäimet,
koodin jakamiseen käytettävä ''Jaa koodi''-näppäin,
käyttöliittymän kielen valinta
sekä kirjautumiseen tarvittavat kentät.
Lisäksi käyttöliittymästä löytyy vasemmalta puolelta suuri värittävä koodimuokkain
sekä oikealta puolelta löytyy sivuston uutiset sekä käyttöohje.
Tällaisia ohjelmia kutsutaan nimellä Integrated Development Environment (IDE).

Kirjautumiskenttää käyttäen rekisteröityneet käyttäjät voivat kirjautua sivustolle.
Kirjautumalla saa käyttöönsä koodin tallentamismahdollisuuden.
Tallennetut koodit tallennetaa palvelimelle
ja ne on käytettävissä kaikilla koneilla.
Kirjautumattomat käyttäjät eivät voi tallentaa koodejaan sivustolle,
mutta he voivat ladata esimerkkikoodeja käyttäen lataa-toimintoa.

Koodimuokkaimena käytämme Ace-tekstinmuokkauskomponenttia \cite{ace_about}.
Ace mahdollistaa koodin monipuolisen muokkaamisen
sekä omien syntaksiväritysten luomisen.
Syntaksiväritys värittää avainsanat omilla väreillään,
mikä selkeyttää koodin lukemista.

Lisäksi Ace mahdollistaa yhdessä kääntäjän kanssa käyttäjän tekemien virheiden näyttämisen jo kirjoittamisen aikana.
Näin käyttäjä saa välitöntä palautetta valitsemallaan omalla äidinkielellään koodissa olevista virheistä ilman,
että tarvitsee ensin suorittaa koodia.
Tämä parantaa ohjelmoijan työskentelyn sujuvuutta.

Teknisesti edellä mainittu ominaisuus on toteutettu siten,
että aina muokkaimen tekstin muuttuessa suoritetaan kääntäjän front-end,
joka tunnistaa kaikki syntaksi- ja tyyppivirheet.
Testikääntäminen suoritetaan mahdollisuuksien mukaan taustasäikeessä (\eng{Web Worker} \cite{w3c_web_worker}).
Näin virheiden tarkistaminen ei hidasta koodin kirjoittamista.

\subsection{Kääntäjä}
\begin{anfxnote}{}
Kääntäjään todellisesta toteutuksesta olisi tarkoitus kertoa tässä.
\end{anfxnote}

EppaBasicin kääntäjä on toteutettu kokonaan \eng{JavaScripti}ä käyttäen.
Näin käyttäjän ei tarvitse asentaa ylimääräisiä liitännäisiä selaimeen
ja kääntäjä integroituu helposti käyttöliittymään.

EppaBasicin kääntäjä koostuu kahdesta osasta: \eng{Front-end}istä ja \eng{Back-end}istä.
\eng{Front-end} tulkitsee ohjelmakoodin syntaksin ja muuttaa sen kääntäjän sisäiseen muotoon.
Samalla se tarkistaa koodin oikeaoppisuuden mukaan lukien tyyppien sopivuuden,
ja on ainoa kääntäjän osa, joka voi kertoa käyttäjälle virheistä.
\eng{Back-end} kääntää ohjelmakoodin \eng{asm.js}-yhteensopivaksi \eng{JavaScript}-koodiksi,
joka suoritetaan ajoympäristössä.

\subsubsection{Front-end}
EppaBasicin \eng{Front-end} koostuu kolmesta osasta:
skannaajasta (eng. \eng{Lexer}), jäsentäjästä (eng. \eng{Parser}) ja tyyppientarkistajasta.

Skannaaja lukee lähdekoodia alusta loppuun ja jakaa sen merkityksellisiin osiin, tokeneihin (eng. \eng{Token}).
Tokeneita ovat erilaiset kielen
avainsanat ($If$, $Then$, $EndIf$, jne.),
luvut ($15$, $-30$, jne.),
merkkijonot ($''HelloWorld''$, $''Teksti\ddot{a}''$, jne.),
muuttujien ja funktioiden nimet ($Print$, $x$, jne.),
kommentit ($' Kommentit alkavat heittomerkill\ddot{a}$, jne.),
erikoismerkit ($+$, $-$, $\wedge$, jne.) sekä
rivinvaihdot ja välilyöntimerkit.
Jos skannaaja löytää pätkän koodia, jota se ei voi jakaa kuuluvaksi edellä mainuttuihin ryhmiin,
skannaaja kertoo käyttäjälle virheestä.
\fxnote{Skannaaja muodostaa lähdekoodista token-virran.}

Jäsentäjä on lukee skannaajalta saamansa token-virran ja muodostaa sen pohjalta kuvan ohjelmakoodista.
EppaBasicin jäsentäjä on tyypiltään \emph{käsinkirjoitettu, rekursiivin, ylhäältä-alas-jäsentäjä}
(eng. \emph{hand-coded, recursive-descent, top-down parser} \cite[kappale 3.3.2]{eac2e}).
EppaBasic käytttää käsinkirjoitettua rekursiivista jäsentäjää,
koska se on yksinkertainen, helposti ymmärrettävä sekä tehokas.
Lisäksi ominaisuuksien lisääminen jäsentäjään on helppoa.

Jäsentäjä lukee token-virrasta seuraavan tokenin ja kutsuu sen perusteella
oikeaa funktiota rekursiivisesti.
Palatessaa funktiot palauttavat muodostamansa \fxnote{alipuun}.
Jos jäsentäjä kohtaa odottamattoman merkin, se kertoo virheestä käyttäjälle.

Tyyppientarkastaja käy rekursiivisesti läpi jäsentäjän luoman syntaksipuun
ja pitää kirjaa jokaisessa kohdassa näkyvistä muuttujista ja niiden tyypeistä.
Näin tyyppientarkastaja voi päätellä jokaiselle lausekkeelle tyypin
ja funktioiden paluuarvojen tyypit.
Samalla tyyppientarkastaja selvittää mihin määritykseen jokainen muuttujan käyttö viittaa
ja mihin funktiomääritykseen jokainen funktiokutsu viittaa.

\subsubsection{Back-end}
EppaBasicin \eng{Back-end} käy rekursiivisesti läpi
\eng{Front-end}in luoman syntaksipuun.
Se, että kielen syntaksi sallii ruudun piirtämisen missä tahansa vaiheessa
monimutkaistaa back-endin toimintaa,
sillä ruutua piirtäessä ajoympäristön on pysäytettävä koodin suorittaminen
ruudun päivittymistä ja käyttäjän syötteen lukemista varten,
minkä jälkeen ohjelman on voitava jatkua pysäytyskohdasta.
Tätä varten \eng{Back-end}issä on \emph{atomicchecker}-niminen komponentti,
joka rekursiivisesti merkitsee jokaiselle syntaksipuun solmulle atomisuuden.
Jokainen solmu puussa on oletuksena atominen poislukien ruudunpäivitysfunktiota kutsuvat solmut,
jotka ovat epäatomisia.
Epäatomisuus periytyy puussa aina vanhemmalle funktiokutsujen yli,
joten tarpeeksi monen iteraation jälkeen puun
jokaiselle solmulle on merkitty atomisuus.

\eng{Back-end} käyttää atomisuutta optimoimaan kääntämistä,
sillä atomisen solmun suorittamista ei voida katkaista keskeltä
ja siten siihen ei myöskään tarvitse voida palata.
Näin kääntäjä voi optimoida kääntämistä
ja pitää atomisissa osissa käytettävät muuttujat rekistereissä muistin sijasta.

Varsinainen kääntäminen tapahtuu käymällä rekursiivisesti syntakispuuta lävitse
ja valitsemalla atomisuuden mukaan oikean tavan kääntää jokainen solmu.
Atomisissa solmuissa kaikki mahdollinen tallennetaan rekistereihin
kun taas epäatomisissa solmuissa käytetään muistia muuttujien arvojen tallentamiseen.

\subsection{Ajoympäristö}
\begin{anfxnote}{}
Tässä on tarkoitus kertoa uudesta ajoympäristöstä.
Toimii webworkereilla taustasäikeessä.
Suoritusta katkotaan kaksisuuntaisen liikenteen sallimiseksi.
Toiseen suuntaa kulkee grafiikkakomennot ja toiseen suuntaan
käyttäjän syötteet sekä joskus myöhemmin mahdollisesti
myös debug-komennot.
\end{anfxnote}

Kun käyttäjä painaa käyttöliittymän ''käynnistä''-nappia,
käyttöliittymä avaa käännöksen jälkeen selaimeen uuden ikkunan,
ajoympäristön.
Ajoympäristö pyytää käynnistyessään käyttöliittymältä kääntäjän kääntämää koodia,
minkä jälkeen ajoympäristö suorittaa koodin.
Ajoympäristö tarjoaa kaikille ohjelmille yhteiset toiminnot,
kuten piirto-, merkkijono- ja matematiikkafunktiot
sekä koodin suorittamisen ajastamisen tarvittavat toiminnot.

Ajoympäristö -- kuten koko käyttöliittymä muutenkin --
on totteutettu käyttäen JavaScriptiä.
Ajoympäristö koostuu kahdesta osasta:
piirtäjästä ja työskentelijästä.
Piirtäjä on tavallinen \eng{JavaScript}-ohjelma,
joka huolehtii näytön piirtämisestä sekä käyttäjän syötteiden lukemisesta.
Ohjelman suorituksen käynnistyessä piirtäjä alustaa myös työskentelijän,
joka pyörii omassa säikeessään käyttäen \eng{Web Worker}ia.
Näin saadaan ohjelman suoritus eristettyä irralleen selaimen toiminnasta,
jolloin ohjelman suorituksen kestäessä
selain ei jäädy.

Piirtäjä ja työskentelijä keskustelevat keskenään käyttäen viestejä.
Viestit voivat olla yksinkertaisia \eng{JavaScript}-merkkijonoja,
-objekteja, -taulukoita ja -lukuja sekä näiden yhdistelmiä.
Viestit kopioituvat lähettäessä, joten arvojen muuttaminen
piirtäjässä ei vaikuta työskentelijän vastaanottamaana arvoon.
Viestejä voi lähettää missä tahansa kohtaa suoritettavaa
\eng{JavaScript}-koodia, mutta niiden lukemiseksi
suoritus on katkaistava.
Tämä ominaisuus on syynä kääntäjän tavallista monimutkaisempaan rakenteeseen.

\subsubsection{Piirtäjä}
Piirtäjä käyttää grafiikan piirtämiseen \eng{HTML5 Canvas} -elementtiä,
joka on nykyään tuettu kaikissa moderneissa selaimissa
\cite{caniuse_canvas}.
Canvas mahdollistaa yksinkertaisten geometristen muotojen piirtämisen tehokkaasti,
mutta myös kuvien käyttäminen on mahdollista.
Käyttäjän syötteen (näppäimistö ja hiiri) lukemiseksi
ohjelma kuuntelee ajoympäristön kaikkia näppäin- ja hiiritapahtumia (eng. \eng{Events}).
Tapahtuman sattuessa piirtäjä lähettää muutoksen työskentelijälle,
joka päivittää omaa tilaansa.
Piirtäjä piirtää näytön työskentelijältä saamiensa ohjeiden mukaan.

\subsubsection{Työskentelijä}
Työskentelijällä on sisäinen tila,
joka sisältää esimerkiksi nykyisen piirtovärin
sekä näppäimistön pohjassa olevat painikkeet.
Sisäinen tila voi muuttua kahdella tavalla:
joko EppaBasic-koodissa kutsutaan komentoa,
joka muuttaa sisäistä tilaa (esimerkiksi piirtovärin asettaminen),
tai piirtäjä lähettää komennon,
joka muuttaa sisäistä tilaa (esimerkiksi hiiren sijainti).
Sisäinen tila vaikuttaa joidenkin EppaBasicin komentojen palauttamiin arvoihin
(esimerkiksi \eb{KeyDown} ja \eb{MouseX})
sekä piirtokomentojen yhteydessä määrittämään
piirtokomennon tarkka toiminta (esimerkiksi viivan paksuus tai väri).

Suurin osa matematiikka-, merkkijono sekä ajanhallintafunktiosta on toteutettu käytännössä
käärimällä \eng{JavaScriptin} tarjoamat funktiot EppaBasicin tarvitsemaan muotoon.
Ne funktiot, joita \eng{JavaScript} ei suoraan tarjoa, on toteutettu
joko käyttämällä kolmannen osapuolen tarjoaamaa kirjastoa
tai yksinkertaisissa tapauksissa kirjoittamalla itse.

Grafiikkafunktiot on toteutettu siten, että ne kerätään sisäiseen piirtojonoon.
Kutsuttaessa \eb{DrawScreen}-komentoa piirtojono lähetetään piirtäjälle.
Näin saadaan varmistettua, että piirtäjä piirtää kaiken kerrallaan
eikä piirroksen osia ilmesty ruudulle sattumanvaraisesti.

\subsection{Kieli}
\begin{anfxnote}{}
Tässä kerrotaan kielen ominaisuuksista
sekä sen vahvoista puolista.
\end{anfxnote}

Itse ohjelmointikieli koostuu Basic-kielille tyypillisesti
englanninkielisistä avainsanoista.
Komentorakenteet koostuvat avainsanapareista,
joista parin ensimmäinen sana aloittaa komentorakenteen
ja toinen lopettaa sen.
Tällaisia pareja ovat esimerkiksi
$If$ ja $End If$,
$For$ ja $Next$
sekä $Do$ ja $Loop$.
Näin lopettavan avainsanan nähdessä on selvää,
minkä tyyppisen rakenteen avainsana lopettaa.
Myös rivinvaihdot ovat merkityksellisiä Basic-kielissä,
sillä jokainen lauseke on kirjoittettava omalle rivilleen.

EppaBasic on vahvasti ja staattisesti tyypitetty.
Vahva tyypittäminen tarkoittaa sitä,
että tyypit muuttuvat vain erikoistapauksissa toisikseen
lausekkeita evaluoidessa.
Staattinen tyypittäminen tarkoittaa sitä,
että tietyn tyyppiseen muuttujaan voidaan tallentaa
vain muuttujan tyypin mukaisia arvoja.
Näin ei tule vahingossa tilanteita,
joissa muuttuja sisältääkin jotain muuta kuin pitäisi.
\end{comment}